import*as w from"node:path";import*as fe from"node:url";import he from"express";import dt from"cors";import yt from"dotenv";import lt from"express";import{createClient as De}from"redis";import V from"winston";import*as Y from"node:url";import*as L from"node:fs";import*as v from"node:path";import we from"winston-daily-rotate-file";var{combine:_e,timestamp:Se,align:xe,printf:Le,errors:Ee}=V.format,ve=Y.fileURLToPath(import.meta.url),Ce=v.dirname(ve),H=v.join(Ce,"..","..","..","..","logs"),j=!1;!j&&!L.existsSync(H)&&(L.mkdirSync(H),j=!0,console.log("Logs folder not found creating a new one"));var d;(function(t){t.ERROR="error",t.WARN="warn",t.INFO="info",t.HTTP="http",t.VERBOSE="verbose",t.DEBUG="debug",t.SILLY="silly"})(d||(d={}));var z=_e(Ee({stack:!0}),Se({format:"YYYY-MM-DD hh:mm:ss.SSS A"}),xe(),Le(t=>t.stack?`[${t.timestamp}] ${t.level}: ${t.message}
Stack Trace - ${t.stack}
`:`[${t.timestamp}] ${t.level}: ${t.message}`)),_=t=>{let e=v.join(H,t);return L.existsSync(e)||L.mkdirSync(e,{recursive:!0}),V.createLogger({level:t,format:z,transports:[new we({level:t,dirname:e,filename:"%DATE%.log",datePattern:"YYYY-MM-DD",zippedArchive:!1,maxSize:"10m",maxFiles:"14d",format:z})]})},k=class{errorLogger=_(d.ERROR);warnLogger=_(d.WARN);infoLogger=_(d.INFO);httpLogger=_(d.HTTP);verboseLogger=_(d.VERBOSE);debugLogger=_(d.DEBUG);sillyLogger=_(d.SILLY);getErrorLogger(){return this.errorLogger}getWarnLogger(){return this.warnLogger}getInfoLogger(){return this.infoLogger}getHttpLogger(){return this.httpLogger}getVerboseLogger(){return this.verboseLogger}getDebugLogger(){return this.debugLogger}getSillyLogger(){return this.sillyLogger}};var Te=new k;function l(t){Te.getErrorLogger().error(t)}var b=class t{static cacheLayer;static getInstance(){if(!t.cacheLayer)throw l("CacheLayer not initialised please initialise using CacheLayer.initialiseDB() method"),new Error("CacheLayer not initialised please initialise using CacheLayer.initialiseDB() method");return t.cacheLayer}static initialiseCache(e){if(t.cacheLayer&&e)throw l("Cache already initialised"),new Error("Cache already initialised");!t.cacheLayer&&e&&(t.cacheLayer=e)}},S=class{static async getInstance(){let e=b.getInstance();return e.isOpen||await e.connect(),e}},Re=De({url:"redis://redis:6379"});b.initialiseCache(Re);var He=await S.getInstance(),$=class{cache=He;async query(e){let{type:r,key:i,keys:o,field:n,index:a}=e;switch(r){case"hget":if(!i||!n)throw l("Key and field are required for HGET."),new Error("Key and field are required for HGET.");return await this.hGet(i,n);case"lindex":if(!i||a===void 0)throw l("Key and index are required for LINDEX."),new Error("Key and index are required for LINDEX.");return await this.lIndex(i,a);case"mget":if(!o||!Array.isArray(o))throw l("Keys array is required for MGET."),new Error("Keys array is required for MGET.");return await this.mGet(o);case"keys":if(!i)throw l("Key pattern is required for KEYS."),new Error("Key pattern is required for KEYS.");return await this.keys(i);case"get":default:if(!i)throw l("Key is required for GET."),new Error("Key is required for GET.");return await this.get(i)}}async get(e){return await this.cache.get(e)}async hGet(e,r){return await this.cache.hGet(e,r)}async lIndex(e,r){return await this.cache.lIndex(e,r)}async mGet(e){return await this.cache.mGet(e)}async keys(e){return await this.cache.keys(e)}},y=new $;var $e=await S.getInstance(),G=class{cache=$e;async query(e){try{let{key:r,value:i,expiry:o,field:n,index:a,type:c}=e;switch(c){case"hset":if(!n||i===void 0)throw l("Field and value are required for HSET."),new Error("Field and value are required for HSET.");return await this.hSet(r,n,i);case"lset":if(a===void 0||i===void 0)throw l("Index and value are required for LSET."),new Error("Index and value are required for LSET.");return await this.lSet(r,a,i);case"incr":return await this.incr(r);case"lPush":if(i===void 0)throw l("Value are required for LPUSH."),new Error("Value are required for LPUSH.");return await this.lPush(r,i);case"decr":return await this.decr(r);case"del":return await this.del(r);case"set":default:if(!r||i===void 0)throw l("Key and value are required for SET."),new Error("Key and value are required for SET.");return o?await this.setWithExpiry(r,i,o):await this.set(r,i)}}catch(r){l(r)}}async set(e,r){return await this.cache.set(e,r)}async setWithExpiry(e,r,i){return await this.cache.set(e,r,{EX:i})}async hSet(e,r,i){return await this.cache.hSet(e,r,i)}async lSet(e,r,i){return await this.cache.lSet(e,r,i)}async lPush(e,r){return await this.cache.lPush(e,r)}async incr(e){return await this.cache.incr(e)}async decr(e){return await this.cache.decr(e)}async del(e){return await this.cache.del(e)}},p=new G;import*as C from"node:path";import*as ee from"node:url";import it from"moment-timezone";import U from"maxmind";import J from"node:path";import Ge from"node:fs";import Ne from"cidr-matcher";import Ae from"node:url";var We=Ae.fileURLToPath(import.meta.url),Ue=J.dirname(We),Fe=J.resolve(Ue,"/app/mainFiles/json/blockList.json"),X=JSON.parse(Ge.readFileSync(Fe,"utf8")),Oe=X.cidrs.map(t=>{let e=t.trim();return/^[0-9.]+$/.test(e)?`${e}/32`:/^[0-9.]+\/\d{1,2}$/.test(e)?e:null}).filter(t=>t!==null),Ke=new Ne(Oe);function N(t){let e=Ke.contains(t),r=X.tor_exit_nodes.includes(t),i={isVpn:!1,isTor:!1,isThreat:"low"};return r&&(i.isTor=!0,i.isThreat="medium"),e&&(i.isVpn=!0,i.isThreat="medium"),e&&r&&(i.isThreat="high"),i}import Q from"node:path";import Be from"node:fs";import je from"node:url";var ze=je.fileURLToPath(import.meta.url),Ve=Q.dirname(ze),Ye=Q.resolve(Ve,"/app/mainFiles/json/FinalCountryCurrencyMap.json"),Je=JSON.parse(Be.readFileSync(Ye,"utf-8"));function A(){return Je}import Z from"node:path";import Xe from"node:fs";import Qe from"node:url";var Ze=Qe.fileURLToPath(import.meta.url),et=Z.dirname(Ze),tt=Z.resolve(et,"/app/mainFiles/json/CountryExtras2.json"),rt=JSON.parse(Xe.readFileSync(tt,"utf-8"));function W(){return rt}var ot=ee.fileURLToPath(import.meta.url),ar=C.dirname(ot),nt=C.resolve("/app/mainFiles/GeoLite2-City/GeoLite2-City.mmdb"),at=C.resolve("/app/mainFiles/GeoLite2-ASN/GeoLite2-ASN.mmdb"),st=A(),ct=W(),F=class t{static ipData;static cityLookup=null;static asnLookup=null;static async getInstance(){return(!t.cityLookup||!t.asnLookup)&&(t.cityLookup=await U.open(nt),t.asnLookup=await U.open(at)),this.ipData?this.ipData:(this.ipData=new t,new t)}getData(e){try{return this.getGeoData(e)}catch(r){return console.log(r),!1}}getGeoData(e){if(e=e.trim(),!U.validate(e))throw new Error("Invalid IP address");if(!t.cityLookup||!t.asnLookup)throw new Error("Initiation failed please make sure you using the class like this 'await IPData.getInstance()'");let i=t.cityLookup.get(e),o=t.asnLookup.get(e),n;if(!i)return null;i.subdivisions&&(n=i.subdivisions[0]);let a=this.getCurrency(i?.country?.iso_code??""),c=this.getExtras(i?.country?.iso_code??""),u=this.getTimeInfo(i?.location?.time_zone??""),g=N(e);return{ip:e,continent:i?.continent?.names?.en||null,continentCode:i?.continent?.code||null,country:i?.country?.names?.en||null,countryCode:i?.country?.iso_code||null,capital:c?.capital||null,region:n?.names?.en||null,regionCode:n?.iso_code||null,city:i?.city?.names?.en||null,postal_Code:i?.postal?.code||null,dial_code:c?.dial_code||null,is_in_eu:c?.is_in_eu!==!1,latitude:i?.location?.latitude||null,longitude:i?.location?.longitude||null,accuracy_radius:i?.location?.accuracy_radius||null,timezone:{time_zone:u?.timezone,abbr:u?.abbr,offset:u?.offset,is_dst:u?.is_dst,utc:u?.utc_time_zone,current_time:u?.current_time},flag:{flag_Icon:c?.flag||null,flag_unicode:c?.unicode||null},currency:a,connection:{number:o?.autonomous_system_number||null,org:o?.autonomous_system_organization||null},security:{...g}}}getCurrency(e){return st[e]||null}getExtras(e){return ct[e]||null}getTimeInfo(e){let r=new Date,i=this.getAbbrAndDST(e),o={timeZone:e,hour12:!1,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",timeZoneName:"short"},n=new Intl.DateTimeFormat("en-GB",o).formatToParts(r),a=de=>n.find(ye=>ye.type===de)?.value??"00",c=`${a("year")}-${a("month")}-${a("day")}T${a("hour")}:${a("minute")}:${a("second")}`,u=new Date(r.toLocaleString("en-US",{timeZone:"UTC"})),g=new Date(r.toLocaleString("en-US",{timeZone:e})),h=Math.round((g.getTime()-u.getTime())/6e4),K=h>=0?"+":"-",E=Math.abs(h),x=String(Math.floor(E/60)).padStart(2,"0"),ge=String(E%60).padStart(2,"0"),B=`${K}${x}:${ge}`;return{timezone:e,current_time:`${c}${B}`,utc_time_zone:B,offset:h*60,abbr:i?.abbr,is_dst:i?.is_dst}}getAbbrAndDST(e){let r=new Date,i=it.tz(e).format("z"),o=new Date(Date.UTC(r.getFullYear(),0,1)),n=-r.toLocaleString("en-US",{timeZone:e}).localeCompare("",void 0),a=-o.toLocaleString("en-US",{timeZone:e}).localeCompare("",void 0);return{abbr:i,is_dst:n!==a}}},T=await F.getInstance();import*as ne from"prom-client";import{Counter as te,Gauge as re,Histogram as ie,Summary as oe}from"prom-client";var m;(function(t){t.counter="Counter",t.gauge="Gauge",t.histogram="Histogram",t.summary="Summary"})(m||(m={}));var O=class{serviceInstance=null;metricsHolder={};constructor(e){this.serviceInstance=e}initiateMetric({metric:e,name:r,help:i,registry:o=this.serviceInstance,buckets:n,metric_custom_name:a=e,labelNames:c=[]}){if(this.metricsHolder[a])throw new Error(`Metric with key "${a}" already exists.`);let u;if(e===m.counter)u=new te({name:r,help:i,labelNames:c,registers:[o]});else if(e===m.gauge)u=new re({name:r,help:i,labelNames:c,registers:[o]});else if(e===m.summary)u=new oe({name:r,help:i,labelNames:c,registers:[o]});else if(n)e===m.histogram&&(u=new ie({name:r,help:i,buckets:n,labelNames:c,registers:[o]}));else throw new Error("Bucket not defined");this.metricsHolder[a]=u}getMetric(e){if(this.metricsHolder[e])return this.metricsHolder[e];throw new Error("Metric not found for metric "+e)}getCounter(e){let r=this.getMetric(e);if(!(r instanceof te))throw new Error(`${e} is not a Counter`);return r}getGauge(e){let r=this.getMetric(e);if(!(r instanceof re))throw new Error(`${e} is not a Gauge`);return r}getHistogram(e){let r=this.getMetric(e);if(!(r instanceof ie))throw new Error(`${e} is not a Histogram`);return r}getSummary(e){let r=this.getMetric(e);if(!(r instanceof oe))throw new Error(`${e} is not a Summary`);return r}getActiveMetrics(){return this.metricsHolder}async getMetricsData(){return this.serviceInstance?.metrics()}resetAllMetrics(){this.metricsHolder={},this.serviceInstance?.resetMetrics()}getContentType(){return this.serviceInstance?.contentType}},s=new O(ne.register);s.initiateMetric({metric:m.counter,name:"ipWho_http_total_request",help:"Total Http Requests",metric_custom_name:"httpTotalCounter"});s.initiateMetric({metric:m.counter,name:"ipWho_http_request",help:"Http Requests",metric_custom_name:"httpReqCounter[MRS]",labelNames:["method","route","status"]});s.initiateMetric({metric:m.counter,name:"ipWho_http_errors_total",help:"Total Http Errors",metric_custom_name:"httpErrorCounter[MRS]",labelNames:["method","route","status"]});s.initiateMetric({metric:m.gauge,name:"ipWho_http_active_requests",help:"Total Active Requests",metric_custom_name:"httpActiveReqGauge[R]",labelNames:["route"]});s.initiateMetric({metric:m.histogram,name:"ipWho_http_request_duration_sec",help:"Tracks Https Latency",metric_custom_name:"httpDuration[MRS]",labelNames:["method","route","status"],buckets:[.01,.05,.1,.3,.5,1,2,5]});s.initiateMetric({metric:m.counter,name:"ipWho_cache_hits_total",help:"Total Cache Hits",metric_custom_name:"cacheHitsCounter[K]",labelNames:["key"]});s.initiateMetric({metric:m.counter,name:"ipWho_cache_misses_total",help:"Total Cache Misses",metric_custom_name:"cacheMissCounter[K]",labelNames:["key"]});s.initiateMetric({metric:m.histogram,name:"ipWho_cache_latency_sec",help:"Tracks Cache Latency",metric_custom_name:"cacheDuration[KH]",labelNames:["key","hit"],buckets:[.001,.005,.01,.05,.1,.3]});s.initiateMetric({metric:m.counter,name:"ipWho_ip_service_users",help:"Tracks hits for /ip route tracking the requestor's IP",metric_custom_name:"ipServiceCounter[ip?]",labelNames:["ip"]});s.initiateMetric({metric:m.counter,name:"ipWho_non_repeating_visitors",help:"Tracks unique users with /me route",metric_custom_name:"uniqueVisitorsCounter[ip?]",labelNames:["ip"]});s.initiateMetric({metric:m.gauge,name:"ipWho_active_session",help:"Tracks Active users on web",metric_custom_name:"activeUsersGauge[ip?]",labelNames:["ip"]});async function D(t,e,r,i=1e5){if(e&&e>i){t.statusCode=429,t.json({success:!1,message:"Monthly Limit Exceed"});return}else e||await p.query({type:"set",value:"0",key:`${r}RL`,expiry:2592e3})}function ut(t){if(!t.ip)throw new Error("Missing ip");return t.ip.replace(/^::ffff:/,"")}async function ae(t,e){let r=ut(t),i=await y.query({type:"get",key:`${r}D`}),o=await y.query({type:"get",key:`${r}RL`}),n=T.getData(r);if(o||(s.getCounter("uniqueVisitorsCounter[ip?]")?.inc({ip:r}),await p.query({type:"incr",key:"meRouteUser"})),await D(e,o,r,1e3),await p.query({type:"incr",key:`${r}RL`}),i){e.json({success:!0,data:JSON.parse(i)});return}if(!n){e.json({success:!1,message:"Invalid/Reserved IP"});return}await p.query({type:"set",key:`${r}D`,value:JSON.stringify(n),expiry:1800}),e.json({success:!0,data:n})}var M=lt.Router();M.get("/",ae);import ht from"express";async function se({getQuery:t,data:e}){let r=t?.split(","),i={};for(let o of r)i[o]=null;if(r.length>0){for(let o of r)e[o]&&(i[o]=e[o]);return i}}import mt from"js2xmlparser";import{Parser as pt}from"json2csv";function I({format:t,data:e,res:r}){if(t==="xml")return r.set("Content-Type","application/xml"),mt.parse("response",e);if(t==="csv")try{let i=new pt,o=ce(e),n=i.parse(o);return r.set("Content-Type","text/csv"),n}catch(i){throw l(i),new Error("CSV Parsing Error")}else return e}function ce(t,e="",r={}){for(let i in t){if(!Object.prototype.hasOwnProperty.call(t,i))continue;let o=e?`${e}.${i}`:i;typeof t[i]=="object"&&t[i]!==null&&!Array.isArray(t[i])?ce(t[i],o,r):r[o]=t[i]}return r}function ft(t){if(!t.ip)throw new Error("Missing ip");return t.ip.replace(/^::ffff:/,"")}async function le(t,e){let r=t.params.ip,i=t.query.format||"json",o=ft(t),n=s.getHistogram("cacheDuration[KH]")?.startTimer({key:"ipData"}),a=s.getHistogram("cacheDuration[KH]")?.startTimer({key:"userRL"}),c=await y.query({type:"get",key:`${r}D`}),u=await y.query({type:"get",key:`${o}RL`}),g=t.query.get;if(s.getCounter("ipServiceCounter[ip?]")?.inc({ip:o}),await p.query({type:"incr",key:"totalIPRequests"}),u||(a&&a({hit:"false"}),await p.query({type:"incr",key:"uniqueUserIP"})),await D(e,u,r),await p.query({type:"incr",key:`${o}RL`}),c)return s.getCounter("cacheHitsCounter[K]")?.inc({key:"ipData"}),n&&n({hit:"true"}),await ue({res:e,data:JSON.parse(c),getQuery:g,format:i});n&&n({hit:"false"}),a&&a({hit:"true"});let h=T.getData(r)||{success:!1,message:"Reserved range/Invalid IP address"};await p.query({type:"set",key:`${r}D`,value:JSON.stringify(h),expiry:1800}),s.getCounter("cacheMissCounter[K]")?.inc({key:"ipData"}),await ue({res:e,data:h,getQuery:g,format:i})}async function ue({res:t,data:e,getQuery:r,format:i}){if(!e||e?.success===!1){t.statusCode=404,t.send(I({format:i,data:e,res:t}));return}let o=e;if(r&&(o=await se({getQuery:r,data:e})),i){t.send(I({format:i,data:{success:!0,data:o},res:t}));return}t.json({success:!0,data:{success:!0,data:o}})}var R=ht.Router();R.get("/",(t,e)=>{if(!t.params.ip){e.statusCode=404,e.json({success:!1,message:"Invalid IP address"});return}});R.get("/:ip",le);import gt from"express";async function me(t,e){let r=t.headers.authorization;if(!r||!r.startsWith("Basic ")){e.set("WWW-Authenticate",'Basic realm="metrics"'),e.status(401).send("Unauthorized");return}let i=r.split(" ")[1],o=Buffer.from(i,"base64").toString("utf-8"),[n,a]=o.split(":");if(n!=="prometheus"||a!=="mysecretpass"){e.status(401).send("Unauthorized");return}try{e.set("Content-Type",s.getContentType());let c=await s.getMetricsData();e.send(c)}catch(c){console.log(c),e.status(500).send("Error collecting metrics")}}var q=gt.Router();q.get("/",me);yt.config();var f=he(),pe=Number(process.env.PORT)||3e3,wt=fe.fileURLToPath(import.meta.url),P=w.dirname(wt),_t=w.resolve(P,"../frontendBuild");f.set("trust proxy",!0);f.use(dt());f.use((t,e,r)=>{let i=["/favicon.ico","/favicon.svg"],o=["/_astro","/static","/public","/assets"],n=t.method,[a,c]=t.originalUrl.split("?"),u=a.split("/").filter(Boolean),g=c?`?${c}`:"",h=u.length>0?`/${u[0]}${g}`:`/${g}`;if(i.includes(a)||o.some(x=>a.startsWith(x)))return r();let E=s.getHistogram("httpDuration[MRS]")?.startTimer({method:n,route:h});s.getGauge("httpActiveReqGauge[R]")?.inc({route:h}),e.on("finish",async()=>{let x=e.statusCode?.toString();s.getCounter("httpTotalCounter")?.inc(),s.getCounter("httpReqCounter[MRS]")?.inc({method:n,route:h,status:x}),s.getGauge("httpActiveReqGauge[R]")?.dec({route:h}),E&&E({status:x})}),r()});f.use(he.static(_t));f.get("/",(t,e)=>{e.sendFile(w.resolve(P,"..","frontendBuild","index.html"))});f.get("/robots.txt",(t,e)=>{e.sendFile(w.join(P,"..","html","robots.txt"))});f.get("/sitemap.xml",(t,e)=>{e.sendFile(w.join(P,"..","html","sitemap.xml"))});f.use("/ip",R);f.use("/me",M);f.get("/bulk/:bulkIP",(t,e)=>{let r=t.params.bulkIP;console.log(r.split(",")),e.json({success:!1,message:"Failed"})});f.use("/metrics",q);f.listen(pe,()=>{console.log(`Listening on Port ${pe}`)});export{f as app};
